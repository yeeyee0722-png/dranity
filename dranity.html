<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drainity Trash Monitor</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Transparent background so it blends when embedded into Canva */
    html, body {
      height: 100%;
      margin: 0;
      background: transparent;
      font-family: Arial, Helvetica, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap {
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      padding: 12px;
      box-sizing: border-box;
      background: rgba(255,255,255,0); /* transparent */
    }
    .card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      background: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    h2 {
      margin: 0;
      font-size: 1.05rem;
      color: #223;
      text-align: center;
    }
    .gauge-wrap {
      position: relative;
      width: 260px;
      height: 140px; /* half circle */
    }
    #gauge {
      width: 100%;
      height: 100%;
    }
    .gauge-value {
      position: absolute;
      left: 50%;
      top: 62%;
      transform: translate(-50%, -50%);
      font-size: 1.6rem;
      font-weight: 700;
      color: #2b7a0b;
      pointer-events: none;
    }
    #alert {
      display: none;
      color: #b82424;
      font-weight: 700;
      margin-top: 6px;
    }
    .chart-wrap {
      width: 100%;
      padding: 6px 0 0 0;
    }
    #lineChart {
      width: 100% !important;
      height: 200px !important;
    }

    /* Make the card responsive */
    @media (max-width: 480px) {
      .gauge-wrap { width: 220px; height: 120px; }
      .gauge-value { font-size: 1.2rem; top: 60%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <h2>Drainity Trash Monitor</h2>

      <div class="gauge-wrap">
        <canvas id="gauge"></canvas>
        <div class="gauge-value" id="gauge-value">--%</div>
      </div>

      <div id="alert">⚠️ Basket almost full! Please clean!</div>

      <div class="chart-wrap">
        <canvas id="lineChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ------- USER CONFIG -------
    const BLYNK_TOKEN = "KjhSZtHxJhagbgtZKZvqBAP1BqY0VhQs"; // your token
    const VPIN = "V0";                                     // virtual pin
    const INTERVAL_MS = 5000;                              // 5 seconds
    const MAX_POINTS = 20;                                 // last 20 data points
    const ALERT_THRESHOLD = 80;                            // percent to alert
    // ---------------------------

    // helper: interpolate green->yellow->red for 0..100
    function percentToColor(p) {
      // p: 0..100
      // We'll interpolate in HSL: green (120deg) -> yellow (60deg) -> red (0deg)
      let hue;
      if (p <= 50) {
        // 0..50 -> 120 .. 60
        hue = 120 - ( (p / 50) * 60 );
      } else {
        // 50..100 -> 60 .. 0
        hue = 60 - ( ((p - 50) / 50) * 60 );
      }
      return `hsl(${hue}, 75%, 45%)`;
    }

    // Create gauge (doughnut half)
    const gaugeCtx = document.getElementById('gauge').getContext('2d');
    const gaugeChart = new Chart(gaugeCtx, {
      type: 'doughnut',
      data: {
        labels: ['filled','empty'],
        datasets: [{
          data: [0, 100],
          backgroundColor: [percentToColor(0), '#e6e6e6'],
          borderWidth: 0
        }]
      },
      options: {
        rotation: -90 * Math.PI/180,
        circumference: 180 * Math.PI/180,
        cutout: '70%',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });

    // Line chart
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Trash Level (%)',
          data: [],
          borderColor: '#2b7a0b',
          backgroundColor: 'rgba(43,122,11,0.15)',
          tension: 0.3,
          fill: true,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // state
    let history = [];

    // fetch from Blynk
    async function fetchBlynk() {
      try {
        const url = `https://blynk.cloud/external/api/get?token=${BLYNK_TOKEN}&${VPIN}`;
        const resp = await fetch(url, {cache: "no-store"});
        if (!resp.ok) throw new Error('Network response not OK');
        const text = await resp.text();
        const num = parseFloat(text);
        if (!isNaN(num)) {
          const value = Math.max(0, Math.min(100, Math.round(num)));
          pushValue(value);
        } else {
          console.warn('Blynk returned non-number:', text);
        }
      } catch (err) {
        console.error('Fetch error:', err);
      }
    }

    function pushValue(v) {
      const now = new Date();
      const label = now.toLocaleTimeString();
      history.push({t: label, v: v});
      if (history.length > MAX_POINTS) history.shift();
      updateDisplays();
    }

    function updateDisplays() {
      const latest = history.length ? history[history.length-1].v : null;
      const gaugeValueEl = document.getElementById('gauge-value');
      const alertEl = document.getElementById('alert');

      // update gauge dataset and color
      const filled = latest === null ? 0 : latest;
      gaugeChart.data.datasets[0].data = [filled, 100 - filled];
      gaugeChart.data.datasets[0].backgroundColor = [percentToColor(filled), '#e6e6e6'];
      gaugeChart.update();

      // update numeric
      gaugeValueEl.textContent = latest === null ? '--%' : (filled + '%');
      gaugeValueEl.style.color = latest >= ALERT_THRESHOLD ? '#b82424' : '#2b7a0b';

      // alert
      if (latest !== null && latest >= ALERT_THRESHOLD) {
        alertEl.style.display = 'block';
      } else {
        alertEl.style.display = 'none';
      }

      // update line chart
      lineChart.data.labels = history.map(d => d.t);
      lineChart.data.datasets[0].data = history.map(d => d.v);
      // update line color gradient depending on latest
      const grad = lineCtx.createLinearGradient(0,0,lineChart.width,0);
      grad.addColorStop(0, '#2b7a0b');
      grad.addColorStop(1, percentToColor(latest===null?0:latest));
      lineChart.data.datasets[0].borderColor = grad;
      lineChart.update();
    }

    // initial fetches to fill some data
    (async function init() {
      // attempt to fetch some initial points (up to 6 quick tries)
      for (let i=0;i<6;i++) {
        await fetchBlynk();
        await new Promise(r=>setTimeout(r, 300));
      }
      // schedule regular updates
      setInterval(fetchBlynk, INTERVAL_MS);
    })();

  </script>
</body>
</html>
